<!DOCTYPE html>
<html>
        <head>
          <title>Discounter - The One Trait</title>
          <link rel="stylesheet" href="../screen.css" type="text/css" media="screen, projection"></link><link rel="stylesheet" href="../print.css" type="text/css" media="print"></link><!--[if lt IE 8]><link rel="stylesheet" href="../ie.css" type="text/css" media="screen, projection"><![endif]-->
          <link href="../prettify.css" rel="stylesheet" type="text/css"></link><script type="text/javascript" src="../prettify.js"></script>
          <style> 
          /* Overriding a few defaults from blueprint. */
          body {font-size:100%;color:#222;background:#f2e5ca;font-family: Georgia, Times, serif;}
          h1, h2, h3, h4, h5, h6 {font-weight:normal;color:#111;font-family: Georgia, Times, serif;text-transform:uppercase;}
          a:focus, a:hover {color: #222;}
          a {color:#7f2f18;text-decoration:none;}
          code { text-transform: none; }
          
          /* Style the code blocks */
          pre {
            background: #333;
            color: #f2e5ca;
            border: solid #444 1px;
            border-left-width: 1em;
          }
          .str { color:rgb( 237, 239, 125 ); font-style:italic }
          .kwd { color:rgb( 152, 129, 85 ); }
          .com { color:#999 }
          .typ { color:rgb( 255, 101, 33 ); }
          .lit { color:rgb( 112, 83, 147 ); }
          .pun { color:#aaa; font-weight:bold  }
          .pln { color:#f2e5ca }
          .tag { color:rgb( 137, 150, 168 ); font-weight:bold  }
          .atn { color:#939; font-weight:bold  }
          .atv { color:#181 }
          .dec { color:#606 }
          
          /* Custom styling */
          .header { background: #7f2f18; color: #f2e5ca; text-transform:uppercase; margin-bottom: 2em; vertical-align: center; }
          .header a { color: #f2e5ca }
          .header a:focus, a:hover {color: #222; background: #7f2f18 }
          .header ul { list-style-type: none; margin: 0; padding: 0; }
          .header ul li { display: inline; padding-right: 2em; }
           </style>
        </head>
        <body onload="prettyPrint()" class="container"><div class="section">
      <div class="header span-22 prepend-1 append-1 last">
      <ul style="list-style-type: none">
            <li><a href="../../..">tristanhunt.com</a></li>
            <li><a href="http://github.com/tristanjuricek/knockoff">GitHub</a></li>
            <li><a href="../../literable">Literable</a></li>
        </ul>
    </div>
      <div class="nav small span-7 prepend-1"><ul><li>
            <a href="../01-Introduction.html">
              Introduction to Knockoff
            </a>
          </li><li>
            <span class="group">Usage</span>
            <ul>
              <li>
            <a href="../10-Usage/01-Getting_Started.html">
              Getting Started
            </a>
          </li><li>
            <a href="../10-Usage/02-Recipes.html">
              Recipes
            </a>
          </li>
            </ul>
          </li><li>
            <span class="group">Implementation</span>
            <ul>
              <li>
            <a href="../30-Implementation/01-Discounter.html">
              Discounter - The One Trait
            </a>
          </li><li>
            <a href="../30-Implementation/02-Block_Elements.html">
              Block Elements
            </a>
          </li><li>
            <a href="../30-Implementation/03-Span_Elements.html">
              Spanning Elements
            </a>
          </li><li>
            <a href="../30-Implementation/04-ElementFactory.html">
              ElementFactory
            </a>
          </li><li>
            <span class="group">Parsing</span>
            <ul>
              <li>
            <a href="../30-Implementation/10-Parsing/01-Parsing.html">
              Parsing Overview
            </a>
          </li><li>
            <a href="../30-Implementation/10-Parsing/10-ChunkStreamFactory.html">
              ChunkStreamFactory
            </a>
          </li><li>
            <a href="../30-Implementation/10-Parsing/11-ChunkParsers.html">
              ChunkParsers
            </a>
          </li><li>
            <a href="../30-Implementation/10-Parsing/12-Chunk_Types.html">
              Chunk Types
            </a>
          </li><li>
            <a href="../30-Implementation/10-Parsing/20-Span_Conversion.html">
              Span Conversion
            </a>
          </li>
            </ul>
          </li><li>
            <a href="../30-Implementation/50-Official_Markdown_Tests.html">
              The Official Tests
            </a>
          </li><li>
            <span class="group">Utilities</span>
            <ul>
              <li>
            <a href="../30-Implementation/80-Utilities/01-String_Extras.html">
              StringExtras
            </a>
          </li><li>
            <a href="../30-Implementation/80-Utilities/02-ColoredLogger.html">
              ColoredLogger
            </a>
          </li>
            </ul>
          </li>
            </ul>
          </li></ul></div>
      <div class="article span-15 append-1 last"><h1><code>Discounter</code> - The One Trait</h1><p>You inherit from <code>KnockOff</code> to be able to parse your sources. If you're not doing
fancy customization, you use the DefaultDiscounter.
</p><pre><code class="prettyprint">val blocks = DefaultDiscounter.knockoff( &quot;document&quot; )

println( &quot;Hello, Conversion!&quot; )
println( blocks.toXML )
</code></pre><p>Otherwise...
</p><pre><code class="prettyprint">// In com/tristanhunt/knockoff/Discounter.scala
// See the Discounter package and imports

trait   Discounter
extends ChunkStreamFactory
with    SpanConverterFactory
with    HasElementFactory {

  /**
    Parses and returns our best guess at the sequence of blocks. It will
    never fail, just log all suspicious things.
  */
  def knockoff( source : java.lang.CharSequence ) : BlockSeq = {
      
    val chunks = createChunkStream( new CharSequenceReader( source, 0 ) )

    // These next lines are really ugly because I couldn't figure out a nice
    // way to match a tuple argument (thank you erasure!)
    val linkDefinitions = chunks.flatMap{ case ((chunk, pos)) =&gt;
      if ( chunk.isLinkDefinition )
        List( chunk.asInstanceOf[ LinkDefinitionChunk ] )
      else
        Nil
    }
    
    val convert = spanConverter( linkDefinitions )
    
    val spanned = chunks.map { chunkAndPos =&gt;
      ( chunkAndPos._1, convert( chunkAndPos._1 ), chunkAndPos._2 )
    }
    
    combine( spanned.toList, new ListBuffer )
  }
  
  /**
    Consume input and append the right thing to the output until empty. The
    Chunk itself determines the &quot;right thing to do&quot;. All chunks only know what
    has come before itself, by peering into the output. (It shouldn't matter
    what comes next...)
  */
  private def combine(
    input   : List[ (Chunk, SpanSeq, Position) ],
    output  : ListBuffer[ Block ]
  ) : BlockSeq = {

    if ( input.isEmpty ) return new GroupBlock( output.toSeq )

    input.head._1.appendNewBlock(
      output,         // Adds block to the _end_
      input.tail,
      input.head._2,  // The spanning sequence (may be ignored)
      input.head._3   // The position shoudl be passed through
    )( elementFactory, this )

    combine( input.tail, output )
  }
}
</code></pre><h4>Package And Imports</h4><pre><code class="prettyprint">// The Discounter package and imports
package com.tristanhunt.knockoff

import scala.collection.mutable.ListBuffer
import scala.util.parsing.input.Position
import scala.util.parsing.input.CharSequenceReader
</code></pre><h3><code>DefaultDiscounter</code></h3><p>For many applications the default is &quot;good enough&quot;. Note that a major aim of this
discounter is to mimic the usage of <code>Markdown.pl</code>.
</p><pre><code class="prettyprint">Markdown.pl [ ??html4tags ] [ ??version ] [ ?shortversion ] [ file ... ]
</code></pre><p>The <code>--html4tags</code> argument will just do nothing, but not be processed as a file.
</p><pre><code class="prettyprint">// In com/tristanhunt/knockoff/DefaultDiscounter.scala
package com.tristanhunt.knockoff

import scala.util.logging.ConsoleLogger

object DefaultDiscounter extends Discounter with ColoredLogger {
  def main( args : Array[ String ] ) : Unit = try {
    if ( args.contains(&quot;--version&quot;) ) {
      Console.err.print( &quot;DefaultDiscounter &quot; )
    }
    if ( args.contains(&quot;--version&quot;) || args.contains(&quot;-shortversion&quot;) ) {
      Console.err.println( &quot;0.5.0-SNAPSHOT&quot; )
      return 0
    }
    
    if ( args.isEmpty ) {
      val sb = new StringBuilder
      var line : String = null
      do {
        line = Console.readLine
        if ( line != null ) sb.append( line )
      } while ( line != null )
      println( knockoff( sb.toString ).toXML.toString )
    } else {
      args.filter( _ != &quot;--html4tags&quot; ).foreach { fileName =&gt;
        println( knockoff( readText( fileName ) ).toXML.toString )
      }
    }
  } catch {
    case th : Throwable =&gt; {
      th.printStackTrace( Console.err )
    }
  }
  
  private def readText( fileName : String ) : String =
    io.Source.fromFile( fileName ).mkString(&quot;&quot;)
}
</code></pre><h2>Variations off of Markdown</h2><p>This has a couple of <em>very</em> subtle adjustments to the base Markdown script:
</p><ol><li>Tabs are passed through. Though why you're using tabs is beyond me, this keeps
like diff tools honest.
</li><li>List items (<code>&lt;li&gt;</code>) only have a sub-paragraph (<code>&lt;p&gt;</code>) if you have complex
content. (In the core script, if you space them widely, you get the sub <code>&lt;p&gt;</code>
element, which made no sense to me.)
</li><li>If you have a code line, followed by another indented line, even if that line's
empty, the empty line is part of the code block.</li></ol></div>
      <div class="footer span-22 prepend-1 append-1 last">
      
    </div>
    </div></body>
      </html>